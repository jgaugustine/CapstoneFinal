<!-- 168b19b9-6fff-4797-b38c-b0dfc65d0b46 7bcbd50f-9773-4418-b32f-a7a17e9e1488 -->
# Instance-based Filter Pipeline and Per-Step Visualization

### Data model

- Define `FilterKind` and `FilterInstance` with unique `id`, `kind`, `params`, `enabled` in `src/types/transformations.ts`.
- Provide `defaultParamsFor(kind)` and `formatValueFor(kind, params)` utilities.

### State and pipeline management

- Lift filter pipeline state into `App.tsx`: `const [pipeline, setPipeline] = useState<FilterInstance[]>([])`.
- Add actions: add (from dropdown), duplicate, delete, toggle enable, reorder (dnd-kit), and update params per instance.

### UI: New adjustment and instance sliders

- In `TransformationSliders.tsx`:
  - Replace `transformOrder: TransformationType[]` with `pipeline: FilterInstance[]`.
  - Render one `DraggableSliderCard` per instance; show type icon/label, instance index, and controls for duplicate/delete.
  - Add a `Button` + `DropdownMenu` above Reset to add a new instance of any `FilterKind`.
  - Keep Reset to clear pipeline or reset params.
- Update `DraggableSliderCard.tsx` to accept `id`, `kind`, `params`, `onChangeParams`, and show duplicate/delete buttons.

### Image processing engine

- In `ImageCanvas.tsx`:
  - Replace individual props (`brightness`, `contrast`, ...) and `transformOrder` with `pipeline: FilterInstance[]` and global flags (e.g., `linearSaturation`).
  - Apply pipeline sequentially to image data; keep matrix-batching for brightness/contrast/saturation/hue blocks, interleaved with per-pixel ops (vibrance/linear-sat).
  - For Pixel Inspector, compute `steps: { id, kind, inputRGB, outputRGB }[]` in order and final `transformedRGB`.

### Pixel Inspector (step aware)

- Update `PixelInspector.tsx` to accept `steps[]` instead of `Record<TransformationType, RGB>`.
- Render a list showing each step’s input → output; clicking a step selects that instance (`onSelectInstance(id)`).

### MathExplanation and tab sync

- `MathExplanation.tsx`:
  - Accept `pipeline`, `selectedInstanceId`, and `onSelectInstance`.
  - In single-tool tabs, show the most recently changed instance of that kind (if any).
  - In “All” view, drive the cube via the selected instance; default to last changed.

### RGBCubeVisualizer behavior

- `RGBCubeVisualizer.tsx`:
  - Add `pipeline`, `selectedInstanceId`, `linearSaturation`.
  - Compute cumulative color up to (but not including) the selected instance (prev), then apply only that instance to get (next).
  - Draw auxiliary arrow strictly from prev → next (user choice 2).
  - Optionally still draw origin→prev dashed and origin→next solid for context.

### Extensibility and new filters

- Centralize transform registry: per-kind builder with `applyPixel`, `buildMatrix`, `isPerPixel`, and default params to simplify adding more filters later.

### Minimal schema for FilterInstance

```ts
export type FilterKind = 'brightness' | 'contrast' | 'saturation' | 'vibrance' | 'hue';
export interface FilterInstance {
  id: string; // nanoid/uuid
  kind: FilterKind;
  params: { value: number } | { vibrance: number } | { hue: number };
  enabled: boolean;
}
```

### Files to update

- `src/types/transformations.ts` (new types, registry, defaults)
- `src/components/TransformationSliders.tsx` (instance list UI + add menu)
- `src/components/DraggableSliderCard.tsx` (instance controls)
- `src/components/ImageCanvas.tsx` (apply instance pipeline, step computation)
- `src/components/PixelInspector.tsx` (step array, selection)
- `src/components/MathExplanation.tsx` (props + drive cube by selected instance)
- `src/components/RGBCubeVisualizer.tsx` (prev→next arrow per selected instance)
- `src/App.tsx` (own pipeline state, wire props)

### To-dos

- [x] Add FilterInstance types, defaults, and transform registry in types/transformations.ts
- [ ] Lift pipeline state and actions into App.tsx and plumb props
- [ ] Add New Adjustment dropdown and wire add/duplicate/delete/toggle/reorder
- [ ] Render instance-based sliders and controls in TransformationSliders
- [ ] Refactor ImageCanvas to apply instance pipeline with batching
- [ ] Update PixelInspector to show steps array and instance selection
- [ ] Update MathExplanation to use selected instance and pipeline
- [ ] Update RGBCubeVisualizer to show prev→next for selected instance only